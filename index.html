<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>WordDock</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#ffffff;
  --card:#ffffff;
  --text:#1e293b;
  --muted:#94a3b8;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(15,23,42,0.10);
  --radius:18px;
  --danger:#600000;
  --success:#005800;
  --cap:680px;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

/* ── LOGIN SCREEN ── */
.login-shell{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;gap:16px}
.login-box{max-width:360px;width:100%;text-align:center}
.login-title{font-size:22px;font-weight:600;margin-bottom:4px}
.login-sub{font-size:13px;color:var(--muted);margin-bottom:24px}
.login-input{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;font-size:15px;font-family:inherit;outline:none;margin-bottom:12px}
.login-input:focus{border-color:#94a3b8}
.login-btn{width:100%;padding:12px;border:none;border-radius:10px;background:var(--text);color:#fff;font-size:14px;font-family:inherit;cursor:pointer;transition:opacity .15s}
.login-btn:hover{opacity:.85}
.login-btn:disabled{opacity:.5;cursor:default}
.login-msg{font-size:13px;margin-top:12px;min-height:1.4em}
.login-msg.ok{color:var(--success)}
.login-msg.err{color:var(--danger)}

/* ── APP ── */
.shell{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:16px 18px;gap:12px}
.stage{width:100%;max-width:var(--cap);flex:1;display:flex;flex-direction:column;justify-content:center;gap:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:26px 30px;min-height:220px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;user-select:none;outline:none;cursor:pointer}
.card-text{font-size:28px;letter-spacing:.2px;white-space:pre-wrap;line-height:1.4;margin:0}
.state-question{color:#6e6e6e}
.state-answer{color:#000000}
.hint{margin-top:8px;font-size:12px;color:var(--muted);text-align:center;user-select:none;min-height:1.2em}
.btnrow{display:flex;gap:10px;justify-content:center}
button{appearance:none;border:1px solid var(--border);background:#fff;color:var(--text);padding:12px 14px;border-radius:14px;font-size:14px;cursor:pointer;min-width:120px;transition:transform .05s ease}
button:active{transform:translateY(1px)}
button:focus{outline:none}
button:disabled{cursor:default;opacity:1;pointer-events:none}
.again{border-color:rgba(96,0,0,0.35);color:var(--danger)}
.good{border-color:rgba(0,88,0,0.35);color:var(--success)}
.bar{width:100%;max-width:var(--cap);display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;user-select:none;font-family:monospace;letter-spacing:.2px}
.bottom-bar{padding-top:6px}
.sync-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;vertical-align:middle}
.sync-ok{background:#00b894}
.sync-err{background:#e17055}
.sync-busy{background:#fdcb6e;animation:pulse .8s infinite alternate}
@keyframes pulse{from{opacity:.4}to{opacity:1}}
.user-email{cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px}

@media(max-width:420px){:root{--cap:100%}.card-text{font-size:24px}button{min-width:110px}}

.hidden{display:none!important}
</style>
</head>
<body>

<!-- ════ LOGIN SCREEN ════ -->
<div class="login-shell" id="loginScreen">
  <div class="login-box">
    <div class="login-title">WordDock</div>
    <div class="login-sub">NL → RU · Vocabulaire trainer</div>
    <input class="login-input" id="emailInput" type="email" placeholder="je e-mailadres" autocomplete="email">
    <button class="login-btn" id="loginBtn">Verstuur magic link</button>
    <div class="login-msg" id="loginMsg"></div>
  </div>
</div>

<!-- ════ APP SCREEN ════ -->
<div class="shell hidden" id="appScreen">
  <div class="stage">
    <div class="card" id="card" tabindex="0">
      <div class="card-text state-question" id="cardText">…</div>
    </div>
    <div class="btnrow">
      <button class="again" id="btnAgain" disabled>Again</button>
      <button class="good" id="btnGood" disabled>Good</button>
    </div>
    <div class="hint" id="hint"></div>
  </div>
  <div class="bar bottom-bar">
    <div><span class="sync-dot sync-ok" id="syncDot"></span><span class="user-email" id="userEmail" title="Klik om uit te loggen"></span></div>
    <div id="cBR">0/10</div>
  </div>
</div>

<script>
/* ═══ SUPABASE CONFIG ═══ */
const SUPA_URL="https://xpnkhxzuxlqwwmoqxdhf.supabase.co";
const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwbmtoeHp1eGxxd3dtb3F4ZGhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNjk2ODYsImV4cCI6MjA4Njc0NTY4Nn0.sqYu_nwx_2Zqyb69rzhYyaX6sbpZCyWliG2fIrfCwhk";
const sb=window.supabase.createClient(SUPA_URL,SUPA_KEY);

/* ═══ DATASET — 127 lemmas NLRU01 ═══ */
const ALL=[
{"id":"NLRU01_0001","s":1,"f":[{"q":"maar","a":"а"}]},
{"id":"NLRU01_0002","s":2,"f":[{"q":"jij","a":"ты"},{"q":"jij spreekt","a":"ты говори́шь"}]},
{"id":"NLRU01_0003","s":3,"f":[{"q":"hij","a":"он"},{"q":"hij spreekt","a":"он говори́т"}]},
{"id":"NLRU01_0004","s":4,"f":[{"q":"zij","a":"она́"},{"q":"zij spreekt","a":"она́ говори́т"}]},
{"id":"NLRU01_0005","s":5,"f":[{"q":"dat","a":"что"},{"q":"Ik denk dat hij thuis is.","a":"Я ду́маю, что он до́ма."}]},
{"id":"NLRU01_0006","s":6,"f":[{"q":"wat?","a":"что?"},{"q":"Wat is dit?","a":"Что э́то?"}]},
{"id":"NLRU01_0007","s":7,"f":[{"q":"met","a":"с (со)"},{"q":"met citroen","a":"с лимо́ном"}]},
{"id":"NLRU01_0008","s":8,"f":[{"q":"van(af)","a":"с (со)"},{"q":"van de tafel","a":"со стола́"}]},
{"id":"NLRU01_0009","s":9,"f":[{"q":"dit","a":"э́то"},{"q":"Dit is een vliegtuig.","a":"э́то самолёт."}]},
{"id":"NLRU01_0010","s":10,"f":[{"q":"maar","a":"а"}]},
{"id":"NLRU01_0011","s":11,"f":[{"q":"alles","a":"весь"}]},
{"id":"NLRU01_0012","s":12,"f":[{"q":"zij (mv.)","a":"они́"}]},
{"id":"NLRU01_0013","s":13,"f":[{"q":"hoe","a":"как"}]},
{"id":"NLRU01_0014","s":14,"f":[{"q":"zoals","a":"как"}]},
{"id":"NLRU01_0015","s":15,"f":[{"q":"wij","a":"мы"}]},
{"id":"NLRU01_0016","s":16,"f":[{"q":"naar","a":"к + dat."}]},
{"id":"NLRU01_0017","s":17,"f":[{"q":"bij","a":"у + gen."}]},
{"id":"NLRU01_0018","s":18,"f":[{"q":"jij","a":"ты"}]},
{"id":"NLRU01_0019","s":19,"f":[{"q":"deze","a":"э́тот"}]},
{"id":"NLRU01_0020","s":20,"f":[{"q":"jullie","a":"вы"}]},
{"id":"NLRU01_0021","s":21,"f":[{"q":"voor","a":"за + acc."},{"q":"betalen voor het water","a":"плати́ть за во́дку"}]},
{"id":"NLRU01_0022","s":22,"f":[{"q":"achter","a":"за + instr."},{"q":"achter het huis","a":"за до́мом"}]},
{"id":"NLRU01_0023","s":23,"f":[{"q":"die","a":"тот"}]},
{"id":"NLRU01_0024","s":24,"f":[{"q":"maar","a":"но"}]},
{"id":"NLRU01_0025","s":25,"f":[{"q":"op, langs, over","a":"по + dat."},{"q":"Ik wandel over straat","a":"Я гуля́ю по у́лице."}]},
{"id":"NLRU01_0026","s":26,"f":[{"q":"van, uit","a":"из"}]},
{"id":"NLRU01_0027","s":27,"f":[{"q":"over","a":"о (об, обо́)"}]},
{"id":"NLRU01_0028","s":28,"f":[{"q":"zijn","a":"свой"}]},
{"id":"NLRU01_0029","s":29,"f":[{"q":"zo","a":"так"}]},
{"id":"NLRU01_0030","s":30,"f":[{"q":"één","a":"оди́н"}]},
{"id":"NLRU01_0031","s":31,"f":[{"q":"ziehier","a":"вот"}]},
{"id":"NLRU01_0032","s":32,"f":[{"q":"die","a":"кото́рый"}]},
{"id":"NLRU01_0033","s":33,"f":[{"q":"welk","a":"кото́рый"}]},
{"id":"NLRU01_0034","s":34,"f":[{"q":"ons","a":"наш"}]},
{"id":"NLRU01_0035","s":35,"f":[{"q":"slechts, alleen","a":"то́лько"}]},
{"id":"NLRU01_0036","s":36,"f":[{"q":"nog (steeds)","a":"ещё"}]},
{"id":"NLRU01_0037","s":37,"f":[{"q":"(weg) van","a":"от"}]},
{"id":"NLRU01_0038","s":38,"f":[{"q":"wat ga jij eten","a":"что ты бу́дешь есть"}]},
{"id":"NLRU01_0039","s":39,"f":[{"q":"uw bad is klaar","a":"ва́ша ва́нна гото́ва"}]},
{"id":"NLRU01_0040","s":40,"f":[{"q":"vertel me erover","a":"расскажи́ мне об э́том"}]},
{"id":"NLRU01_0041","s":41,"f":[{"q":"je kunt dit probleem oplossen","a":"ты мо́жешь реши́ть э́ту пробле́му"}]},
{"id":"NLRU01_0042","s":42,"f":[{"q":"ik heb veel vrienden in het buitenland","a":"у меня́ мно́го друзе́й за грани́цей"}]},
{"id":"NLRU01_0043","s":43,"f":[{"q":"nu studeert ze viool","a":"сейча́с она́ занима́ется скри́пкой"}]},
{"id":"NLRU01_0044","s":44,"f":[{"q":"is dit uw eerste reis naar het buitenland","a":"э́то ва́ша пе́рвая пое́здка за грани́цу"}]},
{"id":"NLRU01_0045","s":45,"f":[{"q":"Ik ken niemand van hen","a":"я никого́ из них не зна́ю"}]},
{"id":"NLRU01_0046","s":46,"f":[{"q":"ik studeer twee uur","a":"я занима́юсь два часа́"}]},
{"id":"NLRU01_0047","s":47,"f":[{"q":"het hangt van jou af","a":"э́то зави́сит от тебя́"}]},
{"id":"NLRU01_0048","s":48,"f":[{"q":"zacht","a":"мя́гкий"}]},
{"id":"NLRU01_0049","s":49,"f":[{"q":"actief","a":"акти́вный"}]},
{"id":"NLRU01_0050","s":50,"f":[{"q":"geel","a":"жёлтый"}]},
{"id":"NLRU01_0051","s":51,"f":[{"q":"nat","a":"мо́крый"}]},
{"id":"NLRU01_0052","s":52,"f":[{"q":"accusatieve naamval","a":"вини́тельный паде́ж"}]},
{"id":"NLRU01_0053","s":53,"f":[{"q":"ze heeft volkomen gelijk","a":"она́ соверше́нно пра́ва"}]},
{"id":"NLRU01_0054","s":54,"f":[{"q":"gisteren ving ik drie vissen","a":"вчера́ я пойма́л трёх рыб"}]},
{"id":"NLRU01_0055","s":55,"f":[{"q":"ik ben zo bij je","a":"я бу́ду с тобо́й че́рез секу́нду"}]},
{"id":"NLRU01_0056","s":56,"f":[{"q":"lucht, hemel","a":"не́бо"}]},
{"id":"NLRU01_0057","s":57,"f":[{"q":"ze liegen nooit","a":"они́ никогда́ не лгут"}]},
{"id":"NLRU01_0058","s":58,"f":[{"q":"quiz","a":"виктори́на"}]},
{"id":"NLRU01_0059","s":59,"f":[{"q":"tuinslang, waterslang","a":"шланг"}]},
{"id":"NLRU01_0060","s":60,"f":[{"q":"buis, trompet","a":"труба́"}]},
{"id":"NLRU01_0061","s":61,"f":[{"q":"ze dwongen mij daarheen te gaan","a":"они́ заста́вили меня́ пойти́ туда́"}]},
{"id":"NLRU01_0062","s":62,"f":[{"q":"Parijs is de hoofdstad van frankrijk","a":"Пари́ж столи́ца фра́нции"}]},
{"id":"NLRU01_0063","s":63,"f":[{"q":"lippen","a":"губы́"}]},
{"id":"NLRU01_0064","s":64,"f":[{"q":"hij is vandaag teruggekeerd uit Sydney","a":"он сего́дня верну́лся из Си́днея"}]},
{"id":"NLRU01_0065","s":65,"f":[{"q":"de bestuurder lag in de auto te slapen","a":"води́тель спал в маши́не"}]},
{"id":"NLRU01_0066","s":66,"f":[{"q":"ik moet mijn overhemd strijken","a":"я до́лжен гла́дить свою́ руба́шку"}]},
{"id":"NLRU01_0067","s":67,"f":[{"q":"ik heb een nieuwe fiets nodig","a":"мне ну́жен но́вый велосипе́д"}]},
{"id":"NLRU01_0068","s":68,"f":[{"q":"ze begroetten me met een glimlach","a":"они́ встре́тили меня́ с улы́бкой"}]},
{"id":"NLRU01_0069","s":69,"f":[{"q":"vandaag is het maandag","a":"сего́дня понеде́льник"}]},
{"id":"NLRU01_0070","s":70,"f":[{"q":"ik zal terugkomen","a":"я верну́сь"}]},
{"id":"NLRU01_0071","s":71,"f":[{"q":"heb je de roman uitgelezen","a":"ты зако́нчил чита́ть рома́н"}]},
{"id":"NLRU01_0072","s":72,"f":[{"q":"je voelt je een beetje koortsig vandaag, nietwaar?","a":"у тебя́ сего́дня небольша́я жара́ не так ли"}]},
{"id":"NLRU01_0073","s":73,"f":[{"q":"zij hebben hun eigen problemen","a":"у них свои́ пробле́мы"}]},
{"id":"NLRU01_0074","s":74,"f":[{"q":"ik weet niet waar mijn horloge is","a":"я не зна́ю где мои́ часы́"}]},
{"id":"NLRU01_0075","s":75,"f":[{"q":"hij was geduldig","a":"он был терпели́в"}]},
{"id":"NLRU01_0076","s":76,"f":[{"q":"ik ben net gebeten door een mug","a":"меня́ то́лько что укуси́л кома́р"}]},
{"id":"NLRU01_0077","s":77,"f":[{"q":"naast iets","a":"ря́дом с че́м-то"}]},
{"id":"NLRU01_0078","s":78,"f":[{"q":"leerlinge (meisje)","a":"учени́ца"}]},
{"id":"NLRU01_0079","s":79,"f":[{"q":"ik zal je een geheim vertellen","a":"я откро́ю тебе́ секре́т"}]},
{"id":"NLRU01_0080","s":80,"f":[{"q":"prepositieve naamval","a":"предло́жный паде́ж"}]},
{"id":"NLRU01_0081","s":81,"f":[{"q":"pop","a":"ку́кла"}]},
{"id":"NLRU01_0082","s":82,"f":[{"q":"zuster, non","a":"мона́шка"}]},
{"id":"NLRU01_0083","s":83,"f":[{"q":"lift","a":"лифт"}]},
{"id":"NLRU01_0084","s":84,"f":[{"q":"staat","a":"госуда́рство"}]},
{"id":"NLRU01_0085","s":85,"f":[{"q":"het oog","a":"глаз"}]},
{"id":"NLRU01_0086","s":86,"f":[{"q":"koningin","a":"короле́ва"}]},
{"id":"NLRU01_0087","s":87,"f":[{"q":"vloer","a":"пол"}]},
{"id":"NLRU01_0088","s":88,"f":[{"q":"ze wonen beneden","a":"они́ живу́т внизу́"}]},
{"id":"NLRU01_0089","s":89,"f":[{"q":"snoepje","a":"конфе́та"}]},
{"id":"NLRU01_0090","s":90,"f":[{"q":"locomotief","a":"локомоти́в"}]},
{"id":"NLRU01_0091","s":91,"f":[{"q":"kalender","a":"календа́рь"}]},
{"id":"NLRU01_0092","s":92,"f":[{"q":"tapijt","a":"ковёр"}]},
{"id":"NLRU01_0093","s":93,"f":[{"q":"veld","a":"по́ле"}]},
{"id":"NLRU01_0094","s":94,"f":[{"q":"de printer heeft papier nodig","a":"при́нтеру нужна́ бума́га"}]},
{"id":"NLRU01_0095","s":95,"f":[{"q":"al mijn vrienden houden van voetbal","a":"все мои́ друзья́ лю́бят футбо́л"}]},
{"id":"NLRU01_0096","s":96,"f":[{"q":"het is een geheim","a":"э́то секре́т"}]},
{"id":"NLRU01_0097","s":97,"f":[{"q":"satellietschotel, antenne","a":"анте́нна"}]},
{"id":"NLRU01_0098","s":98,"f":[{"q":"hij woont naast mij","a":"он живёт ря́дом со мной"}]},
{"id":"NLRU01_0099","s":99,"f":[{"q":"hij brak het wereldrecord","a":"он поби́л мирово́й реко́рд"}]},
{"id":"NLRU01_0100","s":100,"f":[{"q":"roos (bloem)","a":"ро́за"}]},
{"id":"NLRU01_0101","s":101,"f":[{"q":"ik ben van plan om vanavond te studeren","a":"я плани́рую занима́ться сего́дня ве́чером"}]},
{"id":"NLRU01_0102","s":102,"f":[{"q":"hij zette zijn bril af","a":"он снял очки́"}]},
{"id":"NLRU01_0103","s":103,"f":[{"q":"rook je","a":"ты ку́ришь"}]},
{"id":"NLRU01_0104","s":104,"f":[{"q":"waar is het toilet","a":"где туале́т"}]},
{"id":"NLRU01_0105","s":105,"f":[{"q":"ik ben zestien jaar oud","a":"мне шестна́дцать лет"}]},
{"id":"NLRU01_0106","s":106,"f":[{"q":"dit is de hond van Mary","a":"э́то соба́ка Мэ́ри"}]},
{"id":"NLRU01_0107","s":107,"f":[{"q":"hij verontschuldigde zich","a":"он извини́лся"}]},
{"id":"NLRU01_0108","s":108,"f":[{"q":"je wilt niet drinken","a":"ты не хо́чешь пить"}]},
{"id":"NLRU01_0109","s":109,"f":[{"q":"wat zal er gebeuren","a":"что случи́тся"}]},
{"id":"NLRU01_0110","s":110,"f":[{"q":"ik speel tennis","a":"я игра́ю в те́ннис"}]},
{"id":"NLRU01_0111","s":111,"f":[{"q":"hoe heb je het voor mekaar gekregen","a":"как у тебя́ получи́лось"}]},
{"id":"NLRU01_0112","s":112,"f":[{"q":"hij begon te rennen","a":"он на́чал бежа́ть"}]},
{"id":"NLRU01_0113","s":113,"f":[{"q":"ik zal hier zijn van maandag tot en met donderdag","a":"я бу́ду здесь с понеде́льника по четве́рг"}]},
{"id":"NLRU01_0114","s":114,"f":[{"q":"in deze kamer is er niet zo veel zon","a":"в э́той ко́мнате не так мно́го со́лнца"}]},
{"id":"NLRU01_0115","s":115,"f":[{"q":"het nieuwe museum is een bezoek waard","a":"но́вый музе́й сто́ит посети́ть"}]},
{"id":"NLRU01_0116","s":116,"f":[{"q":"de rem werkte niet","a":"то́рмоз не срабо́тал"}]},
{"id":"NLRU01_0117","s":117,"f":[{"q":"het eiland is het hele jaar door warm","a":"о́стров тёплый кру́глый год"}]},
{"id":"NLRU01_0118","s":118,"f":[{"q":"ik weet dat ze slaapt","a":"я зна́ю что она́ спит"}]},
{"id":"NLRU01_0119","s":119,"f":[{"q":"mijn vrouw is op dit moment het avondeten aan het bereiden","a":"моя́ жена́ гото́вит у́жин пря́мо сейча́с"}]},
{"id":"NLRU01_0120","s":120,"f":[{"q":"hij wandelt","a":"он гуля́ет"}]},
{"id":"NLRU01_0121","s":121,"f":[{"q":"ik moet gaan","a":"мне пора́ идти́"}]},
{"id":"NLRU01_0122","s":122,"f":[{"q":"je bent niet jonger dan ik","a":"ты не моло́же меня́"}]},
{"id":"NLRU01_0123","s":123,"f":[{"q":"met wat ben je bezig","a":"чем ты занима́ешься"}]},
{"id":"NLRU01_0124","s":124,"f":[{"q":"hij spreekt Frans","a":"он говори́т по-францу́зски"}]},
{"id":"NLRU01_0125","s":125,"f":[{"q":"deze taart is zoet","a":"э́тот торт сла́дкий"}]},
{"id":"NLRU01_0126","s":126,"f":[{"q":"ik spreek niet graag in het openbaar","a":"я не люблю́ говори́ть на пу́блике"}]},
{"id":"NLRU01_0127","s":127,"f":[{"q":"de stoel","a":"стул"}]},
];

/* ═══ RS STORE ═══ */
const RS_KEY="wd_rs";
let RS={};
try{RS=JSON.parse(localStorage.getItem(RS_KEY))||{}}catch(e){RS={}}
function getRS(id){return RS[id]||0}
function saveRS(){localStorage.setItem(RS_KEY,JSON.stringify(RS))}

/* ═══ SUPABASE SYNC ═══ */
let currentUser=null;

async function loadRSFromSupabase(){
  if(!currentUser)return;
  setSyncState("busy");
  try{
    const{data,error}=await sb.from("user_progress")
      .select("lemma_id,rs")
      .eq("user_id",currentUser.id);
    if(error)throw error;
    if(data&&data.length>0){
      data.forEach(r=>{RS[r.lemma_id]=r.rs});
      saveRS();
    }
    setSyncState("ok");
  }catch(e){
    console.error("Load RS error:",e);
    setSyncState("err");
  }
}

async function pushRSToSupabase(deckRS){
  if(!currentUser)return;
  setSyncState("busy");
  try{
    const rows=Object.entries(deckRS).map(([lid,delta])=>({
      user_id:currentUser.id,
      lemma_id:lid,
      rs:Math.max(0,(RS[lid]||0)),
      updated_at:new Date().toISOString()
    }));
    const{error}=await sb.from("user_progress")
      .upsert(rows,{onConflict:"user_id,lemma_id"});
    if(error)throw error;
    setSyncState("ok");
  }catch(e){
    console.error("Push RS error:",e);
    setSyncState("err");
  }
}

function setSyncState(s){
  const dot=document.getElementById("syncDot");
  dot.className="sync-dot sync-"+s;
}

/* ═══ AUTH ═══ */
const $login=document.getElementById("loginScreen");
const $app=document.getElementById("appScreen");
const $emailInput=document.getElementById("emailInput");
const $loginBtn=document.getElementById("loginBtn");
const $loginMsg=document.getElementById("loginMsg");
const $userEmail=document.getElementById("userEmail");

$loginBtn.addEventListener("click",async()=>{
  const email=$emailInput.value.trim();
  if(!email){$loginMsg.textContent="Vul je e-mail in";$loginMsg.className="login-msg err";return}
  $loginBtn.disabled=true;$loginBtn.textContent="Bezig...";
  try{
    const{error}=await sb.auth.signInWithOtp({email,options:{emailRedirectTo:window.location.href}});
    if(error)throw error;
    $loginMsg.textContent="✓ Check je inbox — klik de link om in te loggen";
    $loginMsg.className="login-msg ok";
  }catch(e){
    $loginMsg.textContent="Fout: "+e.message;
    $loginMsg.className="login-msg err";
  }
  $loginBtn.disabled=false;$loginBtn.textContent="Verstuur magic link";
});

$emailInput.addEventListener("keydown",e=>{if(e.key==="Enter")$loginBtn.click()});

$userEmail.addEventListener("click",async()=>{
  if(confirm("Uitloggen?")){
    await sb.auth.signOut();
    currentUser=null;
    $login.classList.remove("hidden");
    $app.classList.add("hidden");
  }
});

async function checkSession(){
  const{data:{session}}=await sb.auth.getSession();
  if(session){
    currentUser=session.user;
    showApp();
  }
  sb.auth.onAuthStateChange((event,session)=>{
    if(event==="SIGNED_IN"&&session){
      currentUser=session.user;
      showApp();
    }
  });
}

async function showApp(){
  $login.classList.add("hidden");
  $app.classList.remove("hidden");
  $userEmail.textContent=currentUser.email;
  await loadRSFromSupabase();
  initDeck();
  $card.focus();
}

/* ═══ DECK ASSEMBLY — 10 lowest RS, ties by serial ═══ */
function assembleDeck(){
  const sorted=ALL.slice().sort((a,b)=>{
    const d=getRS(a.id)-getRS(b.id);
    return d!==0?d:a.s-b.s;
  });
  return sorted.slice(0,10);
}

/* ═══ PIPE ENGINE ═══ */
let pipe=[];
let showingAnswer=false;
let deckComplete=false;
let deckRS={};

function initDeck(){
  const lemmas=assembleDeck();
  pipe=lemmas.map(l=>({lemma:l,fi:0,dirty:false,dc:0,restart:false,done:false}));
  deckRS={};
  deckComplete=false;
  showingAnswer=false;
  render();
}

function cur(){return pipe[0]}

function reveal(){
  if(deckComplete||showingAnswer)return;
  showingAnswer=true;
  render();
}

function gradeGood(){
  if(!showingAnswer||deckComplete)return;
  showingAnswer=false;
  const s=cur();
  s.fi++;
  /* last field reached? */
  if(s.fi>=s.lemma.f.length){
    if(s.dirty&&!s.restart){
      /* dirty, not yet restarted → restart from field 0, stay at pos 0 */
      s.restart=true;s.fi=0;render();return;
    }
    if(s.restart){
      /* just finished restart pass → redeemed, move to position 4 */
      s.done=true;s.restart=false;s.fi=0;
      moveTo(3);
      checkDone();render();return;
    }
    /* clean pass → done, move to end */
    s.done=true;s.fi=0;
    moveTo(pipe.length-1);
    checkDone();render();return;
  }
  render();
}

function gradeAgain(){
  if(!showingAnswer||deckComplete)return;
  showingAnswer=false;
  const s=cur();
  s.dirty=true;
  s.dc=Math.min(s.dc+1,2);
  /* stay on same field — user must get it right */
  render();
}

function moveTo(ti){
  const s=pipe.shift();
  const i=Math.min(ti,pipe.length);
  pipe.splice(i,0,s);
}

function checkDone(){
  if(pipe.every(s=>s.done)){
    deckComplete=true;
    /* calculate RS deltas */
    pipe.forEach(s=>{
      if(s.dc===0)deckRS[s.lemma.id]=1;
      else if(s.dc===1)deckRS[s.lemma.id]=-1;
      else deckRS[s.lemma.id]=-2;
    });
    /* apply to local RS */
    for(const[id,d]of Object.entries(deckRS)){
      RS[id]=Math.max(0,(RS[id]||0)+d);
    }
    saveRS();
    /* push to Supabase */
    pushRSToSupabase(deckRS);
  }
}

/* ═══ RENDER ═══ */
const $card=document.getElementById("card");
const $text=document.getElementById("cardText");
const $hint=document.getElementById("hint");
const $bA=document.getElementById("btnAgain");
const $bG=document.getElementById("btnGood");
const $cBR=document.getElementById("cBR");

function render(){
  if(deckComplete){
    $text.textContent="Deck voltooid";
    $text.className="card-text state-answer";
    const c=pipe.filter(s=>s.dc===0).length;
    $hint.textContent="Klik of spatie voor volgend deck";
    $bA.disabled=true;$bG.disabled=true;
    $cBR.textContent=c+"✓ "+(10-c)+"✗";
    return;
  }
  const s=cur();
  const field=s.lemma.f[s.fi];
  if(showingAnswer){
    $text.textContent=field.a;
    $text.className="card-text state-answer";
    $bA.disabled=false;$bG.disabled=false;
  }else{
    $text.textContent=field.q;
    $text.className="card-text state-question";
    $bA.disabled=true;$bG.disabled=true;
  }
  $hint.textContent=s.restart?"⟳ herhaling":"";
  const done=pipe.filter(s=>s.done).length;
  $cBR.textContent=done+"/10";
}

/* ═══ INPUT ═══ */
$card.addEventListener("click",()=>{
  if(deckComplete){initDeck();return}
  if(!showingAnswer)reveal();
});
$bG.addEventListener("click",e=>{gradeGood();e.target.blur()});
$bA.addEventListener("click",e=>{gradeAgain();e.target.blur()});
document.addEventListener("keydown",e=>{
  if(e.key===" "||e.key==="Enter"){
    e.preventDefault();
    if(deckComplete){initDeck();return}
    if(!showingAnswer)reveal();else gradeGood();
  }
  if(e.key==="ArrowLeft"&&showingAnswer){e.preventDefault();gradeAgain()}
});

/* ═══ START ═══ */
(async()=>{
  /* If URL has auth hash (#access_token or #error), let Supabase process it first */
  if(window.location.hash&&window.location.hash.length>1){
    /* Give Supabase client time to pick up the hash tokens */
    await new Promise(r=>setTimeout(r,500));
    /* Clear the hash to prevent reprocessing on refresh */
    if(window.location.hash.includes("access_token")||window.location.hash.includes("error")){
      history.replaceState(null,"",window.location.pathname);
    }
  }
  checkSession();
})();
</script>
</body>
</html>
